{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <div class="d-flex align-items-center mb-4">
    <h3 class="me-auto">Shaxsiy statistika: {{ topic.title }}</h3>
    <a href="/api/topic-panel/student/panel/" class="btn btn-outline-secondary me-2">‚Üê Orqaga</a>
  </div>
  <form method="get" class="row g-2 mb-3">
    <div class="col-auto">
      <input type="date" name="start" value="{{ start_filter }}" class="form-control" placeholder="Boshlanish">
    </div>
    <div class="col-auto">
      <input type="date" name="end" value="{{ end_filter }}" class="form-control" placeholder="Tugash">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary"><i class="fas fa-filter me-1"></i>Filtrlash</button>
    </div>
  </form>
  {% if items %}
  <div class="table-responsive shadow-sm rounded bg-white p-3">
    <table class="table table-striped align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Test</th>
          <th>Ball</th>
          <th>Foiz</th>
          <th>To'g'ri / Jami</th>
          <th>Vaqt</th>
        </tr>
      </thead>
      <tbody>
        {% for i in items %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ i.test_title }}</td>
            <td><span class="badge bg-success">{{ i.score }}</span></td>
            <td>{{ i.percent }}%</td>
            <td>{{ i.correct }} / {{ i.total_q }}</td>
            <td>{{ i.finished_at|date:'Y-m-d H:i' }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <canvas id="statsChart" height="180" class="mt-4"></canvas>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function(){
      const raw = {{ items|safe }};
      const labels = raw.map(r=> r.test_title);
      const perc = raw.map(r=> r.percent);
      const scores = raw.map(r=> r.score);
      const maxScore = Math.max(...scores, 0) || 1;
      const ctx = document.getElementById('statsChart').getContext('2d');
      new Chart(ctx, {
        data: {
          labels,
          datasets: [
            {
              type: 'bar',
              label: 'Ball',
              data: scores,
              backgroundColor: 'rgba(16,185,129,0.55)',
              borderColor: '#10b981',
              borderWidth: 1,
              yAxisID: 'yScore'
            },
            {
              type: 'line',
              label: 'Foiz %',
              data: perc,
              borderColor: '#6366f1',
              backgroundColor: 'rgba(99,102,241,0.25)',
              borderWidth: 2,
              tension: 0.3,
              pointRadius: 4,
              yAxisID: 'yPercent'
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
            plugins: {
              tooltip: { callbacks: { label: (ctx)=> ctx.dataset.label + ': ' + ctx.formattedValue + (ctx.dataset.yAxisID==='yPercent'?'%':'') } },
              legend: { labels: { font: { size: 12 } } }
            },
            scales: {
              yPercent: {
                type: 'linear',
                position: 'right',
                beginAtZero: true,
                max: 100,
                grid: { drawOnChartArea: false },
                ticks: { callback: v=> v + '%' }
              },
              yScore: {
                type: 'linear',
                position: 'left',
                beginAtZero: true,
                suggestedMax: maxScore,
              },
              x: { ticks: { autoSkip: false, maxRotation: 55, minRotation: 0 } }
            }
        }
      });
    })();
  </script>
  {% else %}
    <div class="alert alert-info">Hali yakunlangan testlaringiz yo'q.</div>
  {% endif %}
</div>
{% endblock %}
