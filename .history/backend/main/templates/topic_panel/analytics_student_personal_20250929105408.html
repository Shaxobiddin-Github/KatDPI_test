{% extends 'base.html' %}
{% block content %}
<div class="personal-analytics-page" id="personalRoot">
  <!-- Hero Section -->
  <div class="hero-section hero-v2">
    <div class="container">
      <div class="hero-grid">
        <div class="hero-left">
          <div class="hero-top-row">
            <a href="/api/topic-panel/student/panel/" class="btn-back-solid" title="Orqaga">
              <i class="fas fa-arrow-left"></i><span class="d-none d-sm-inline"> Orqaga</span>
            </a>
            <button type="button" id="darkToggle" class="theme-toggle" title="Tungi rejim">
              <i class="fas fa-moon"></i>
            </button>
          </div>
          <h1 class="hero-heading">Shaxsiy statistika</h1>
          <p class="hero-subtitle">{{ topic.title }}</p>
          {% if personal_stats.total_attempts %}
          <div class="hero-mini-stats">
            <div class="mini-item">
              <span class="mini-label">Urinish</span>
              <span class="mini-value">{{ personal_stats.total_attempts }}</span>
            </div>
            <div class="mini-item">
              <span class="mini-label">O'rtacha %</span>
              <span class="mini-value">{{ personal_stats.avg_percent }}%</span>
            </div>
            <div class="mini-item">
              <span class="mini-label">Eng yaxshi</span>
              <span class="mini-value">{{ personal_stats.best_percent }}%</span>
            </div>
            <div class="mini-item">
              <span class="mini-label">Pass rate</span>
              <span class="mini-value">{{ personal_stats.pass_rate }}%</span>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="container">
      <!-- NEW: Test selection + overall summary -->
      {% if tests_select %}
      <div class="mb-4 d-flex flex-column flex-md-row gap-3 align-items-start align-items-md-center">
        <div class="flex-grow-1">
          <label class="form-label small text-muted mb-1">Test tanlash</label>
          <select id="testSelect" class="form-select form-select-sm">
            {% for t in tests_select %}
              <option value="{{ t.id }}" {% if t.id == default_test_id %}selected{% endif %}>{{ t.title }}</option>
            {% endfor %}
            <option value="__all__">Barchasi (agg)</option>
          </select>
        </div>
        <div class="d-flex gap-3 flex-wrap small" id="overallSummary" style="min-width:260px">
          <div class="p-2 rounded bg-light-subtle border overall-pill" data-k="attempts"><span class="fw-semibold" id="overallAttempts">0</span> urinish</div>
          <div class="p-2 rounded bg-light-subtle border overall-pill" data-k="avg"><span class="fw-semibold" id="overallAvg">0%</span> o'rtacha</div>
          <div class="p-2 rounded bg-light-subtle border overall-pill" data-k="best"><span class="fw-semibold" id="overallBest">0%</span> eng yaxshi</div>
          <div class="p-2 rounded bg-light-subtle border overall-pill" data-k="pass"><span class="fw-semibold" id="overallPass">0%</span> o'tish</div>
        </div>
      </div>
      {% endif %}

      <!-- Filter Section - Improved Design -->
      <div class="filter-section-modern">
        <div class="filter-card">
          <div class="filter-header">
            <h5 class="filter-title">
              <i class="fas fa-filter"></i>
              Filtrlar
            </h5>
          </div>
          
          <form method="get" class="filter-form-modern">
            <!-- Date Range Row -->
            <div class="row g-3 mb-3">
              <div class="col-md-4">
                <label class="form-label small text-muted">Sana oralig'i</label>
                <div class="row g-2">
                  <div class="col-6">
                    <input type="date" name="start" value="{{ start_filter }}" class="form-control form-control-sm" placeholder="Dan">
                  </div>
                  <div class="col-6">
                    <input type="date" name="end" value="{{ end_filter }}" class="form-control form-control-sm" placeholder="Gacha">
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <label class="form-label small text-muted">Tez filtrlar</label>
                <div class="quick-filter-group">
                  <button class="quick-filter-chip" type="button" data-range="7">7 kun</button>
                  <button class="quick-filter-chip" type="button" data-range="30">30 kun</button>
                  <button class="quick-filter-chip" type="button" data-range="all">Barchasi</button>
                </div>
              </div>
              
              <div class="col-md-4">
                <label class="form-label small text-muted">O'tish chegarasi</label>
                <div class="input-group input-group-sm">
                  <input type="number" id="passThreshold" class="form-control" value="{{ personal_stats.pass_threshold }}" min="0" max="100">
                  <span class="input-group-text">%</span>
                </div>
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="filter-actions">
              <button type="submit" class="btn btn-primary btn-sm px-3">
                <i class="fas fa-search me-1"></i>
                Qidirish
              </button>
              {% if start_filter or end_filter %}
                <a href="?" class="btn btn-outline-secondary btn-sm px-3">
                  <i class="fas fa-times me-1"></i>
                  Tozalash
                </a>
              {% endif %}
            </div>
          </form>
        </div>
      </div>

      {% if personal_stats.total_attempts %}
      <!-- Statistics Cards - Improved Layout -->
      <div class="row g-3 stats-section mb-4">
        <div class="col-sm-6 col-lg-3">
          <div class="stat-card-modern primary">
            <div class="stat-header">
              <div class="stat-icon-wrapper">
                <i class="fas fa-layer-group"></i>
              </div>
              <div class="stat-main">
                <div class="stat-value">{{ personal_stats.total_attempts }}</div>
                <div class="stat-label">Jami urinishlar</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-sm-6 col-lg-3">
          <div class="stat-card-modern success">
            <div class="stat-header">
              <div class="stat-icon-wrapper">
                <i class="fas fa-chart-line"></i>
              </div>
              <div class="stat-main">
                <div class="stat-value">{{ personal_stats.avg_percent }}%</div>
                <div class="stat-label">O'rtacha natija</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-sm-6 col-lg-3">
          <div class="stat-card-modern warning">
            <div class="stat-header">
              <div class="stat-icon-wrapper">
                <i class="fas fa-trophy"></i>
              </div>
              <div class="stat-main">
                <div class="stat-value">{{ personal_stats.best_percent }}%</div>
                <div class="stat-label">Eng yaxshi natija</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-sm-6 col-lg-3">
          <div class="stat-card-modern info">
            <div class="stat-header">
              <div class="stat-icon-wrapper">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="stat-main">
                <div class="stat-value" id="passRateVal">{{ personal_stats.pass_rate }}%</div>
                <div class="stat-label">O'tish foizi</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div class="results-section">
        <div class="section-header">
          <div class="section-title">
            <i class="fas fa-chart-bar"></i>
            <h2>Test natijalari</h2>
          </div>
          <div class="section-actions">
            <span class="sort-hint">
              <i class="fas fa-sort"></i>
              Saralash uchun ustunni bosing
            </span>
          </div>
        </div>
        <div class="results-table-container" id="attemptCard">
    <div class="table-responsive">
      <table class="table table-hover table-borderless align-middle mb-0 attempts-table" id="attemptsTbl">
        <thead class="table-light">
          <tr>
            <th data-sort="num">#</th>
            <th data-sort="text">Test</th>
            <th class="text-center" data-sort="num">Ball</th>
            <th style="width:170px" data-sort="num">Foiz</th>
            <th class="text-center" data-sort="num">To'g'ri/Jami</th>
            <th data-sort="date">Vaqt</th>
            <th> </th>
          </tr>
        </thead>
        <tbody id="attemptBody">
          {% for i in items %}
          <tr data-idx="{{ forloop.counter0 }}">
            <td class="fw-semibold row-index">{{ forloop.counter }}</td>
            <td class="test-title">{{ i.test_title }}</td>
            <td class="text-center"><span class="badge pass-badge" data-percent="{{ i.percent }}">{{ i.score }}</span></td>
            <td>
              <div class="progress progress-thin">
                <div class="progress-bar percent-bar" data-percent="{{ i.percent }}" style="width: {{ i.percent }}%">{{ i.percent }}%</div>
              </div>
            </td>
            <td class="text-center small"><span class="text-success fw-semibold">{{ i.correct }}</span>/<span class="text-muted total-q">{{ i.total_q }}</span></td>
            <td class="small text-muted time-cell" data-time="{{ i.finished_at|date:'Y-m-d H:i' }}">{{ i.finished_at|date:'Y-m-d H:i' }}</td>
            <td><button class="btn btn-sm btn-outline-primary attempt-detail" type="button"><i class="fas fa-magnifying-glass"></i></button></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="card-footer text-center p-2">
      <button class="btn btn-sm btn-outline-primary" id="loadMore" type="button">Yana yuklash</button>
    </div>
  </div>

  <!-- Attempt Detail Modal -->
  <div class="modal fade" id="attemptModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Urinish tafsilotlari</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="attemptMeta" class="mb-3 small text-muted"></div>
          <div id="attemptQuestions" class="list-group small"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Yopish</button>
        </div>
      </div>
    </div>
  </div>

        <!-- Chart Section -->
        <div class="chart-section">
          <div class="chart-header">
            <h3 class="chart-title">
              <i class="fas fa-chart-area"></i>
              Natijalar dinamikasi
            </h3>
          </div>
          <div class="chart-container">
            <canvas id="statsChart"></canvas>
          </div>
        </div>
        {% else %}
        <div class="empty-state">
          <div class="empty-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <h3 class="empty-title">Statistika mavjud emas</h3>
          <p class="empty-description">Hali yakunlangan testlaringiz yo'q. Birinchi testni topshiring!</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<style>
/* Global Variables */
:root {
  --primary-color: #6366f1;
  --primary-light: #a5b4fc;
  --primary-dark: #4f46e5;
  --success-color: #10b981;
  --warning-color: #f59e0b;
  --danger-color: #ef4444;
  --info-color: #06b6d4;
  --dark-bg: #0f172a;
  --dark-card: #1e293b;
  --dark-border: #334155;
  --light-bg: #f8fafc;
  --light-card: #ffffff;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --border-color: #e2e8f0;
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
  --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
}

/* Dark Mode */
.dark {
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --border-color: var(--dark-border);
  --light-bg: var(--dark-bg);
  --light-card: var(--dark-card);
}

/* Base Styles */
.personal-analytics-page {
  min-height: 100vh;
  background: linear-gradient(135deg, var(--light-bg) 0%, #e0e7ff 100%);
  transition: all 0.3s ease;
}

.dark .personal-analytics-page {
  background: linear-gradient(135deg, var(--dark-bg) 0%, #1e1b4b 100%);
}

/* Hero Section */
.hero-section {
  background: radial-gradient(circle at 25% 25%, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0) 60%),
              linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
  color: #fff;
  padding: 3.2rem 0 2.6rem;
  position: relative;
  overflow: hidden;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 6px 25px -10px rgba(31,41,55,.4);
}

.hero-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background:
    radial-gradient(circle at 80% 20%, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0) 55%),
    radial-gradient(circle at 15% 75%, rgba(255,255,255,0.18) 0%, rgba(255,255,255,0) 60%),
    url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="p" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="18" cy="22" r="1" fill="white" opacity="0.10"/><circle cx="78" cy="42" r="1" fill="white" opacity="0.10"/><circle cx="42" cy="82" r="1" fill="white" opacity="0.10"/></pattern></defs><rect width="100" height="100" fill="url(%23p)"/></svg>');
  pointer-events: none;
  mix-blend-mode: overlay;
}

.hero-content {
  position: relative;
  z-index: 1;
  display:flex;
  flex-direction:column;
  gap:1.25rem;
}

/* Enhanced hero inner layout */
.hero-title {position:relative;}
.hero-heading {font-size: clamp(1.8rem, 3.2vw, 2.45rem); font-weight:700; letter-spacing:.5px; margin:0 0 .4rem; text-shadow:0 3px 8px rgba(0,0,0,.35);} 
.hero-subtitle {margin:0 0 .9rem; font-size: .95rem; font-weight:500; letter-spacing:.5px; opacity:.95; text-transform:uppercase; color:rgba(255,255,255,.85);} 
.hero-badge {display:inline-flex; align-items:center; gap:.4rem; background:rgba(255,255,255,.12); padding:.55rem .95rem; border:1px solid rgba(255,255,255,.25); border-radius: 40px; backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); box-shadow:0 4px 14px -4px rgba(0,0,0,.35);} 
.hero-badge .attempts-count {font-size:1.05rem; font-weight:700; line-height:1;}
.hero-badge .attempts-label {font-size:.65rem; text-transform:uppercase; letter-spacing:1px; font-weight:600; opacity:.85;}

/* Decorative underline */
.hero-heading::after {content:''; display:block; width:72px; height:4px; margin-top:.6rem; background:linear-gradient(90deg,#ffffff,#a5b4fc); border-radius:4px; box-shadow:0 2px 6px -2px rgba(0,0,0,.4);} 

/* Back button refine alignment */
.back-button-wrapper {top:1.25rem; left:1.1rem;}
.back-btn-hero {font-size:.8rem;}
.back-btn-hero i {font-size:.85rem;}
.back-btn-hero:hover {transform:translateY(-2px);} 

@media (max-width: 576px){
  .hero-section {padding: 2.4rem 0 1.9rem;}
  .back-button-wrapper {top:.9rem; left:.85rem;}
  .hero-heading {font-size:1.7rem;}
  .hero-badge {padding:.45rem .75rem;}
}

/* ====== HERO V2 ====== */
.hero-v2 {padding:2.6rem 0 1.8rem;}
.hero-grid {display:flex; align-items:flex-start; justify-content:space-between; gap:2rem;}
.hero-left {max-width:780px;}
.hero-top-row {display:flex; align-items:center; gap:.75rem; margin-bottom:1.1rem;}
.btn-back-solid {display:inline-flex; align-items:center; gap:.45rem; background:#ffffff; color:#1e293b; font-weight:600; padding:.55rem 1rem; border-radius:10px; text-decoration:none; font-size:.8rem; border:1px solid #e2e8f0; box-shadow:0 4px 14px -4px rgba(0,0,0,.25); transition:.25s;} 
.btn-back-solid i {font-size:.75rem;}
.btn-back-solid:hover {background:#2563eb; color:#ffffff; border-color:#1d4ed8; box-shadow:0 8px 28px -6px rgba(37,99,235,.5);} 
.theme-toggle {background:rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.35); color:#fff; width:38px; height:38px; display:inline-flex; align-items:center; justify-content:center; border-radius:10px; cursor:pointer; transition:.25s;} 
.theme-toggle:hover {background:rgba(255,255,255,.3);} 
.hero-mini-stats {display:flex; flex-wrap:wrap; gap:.65rem; margin-top:1.2rem;}
.mini-item {background:rgba(255,255,255,.14); padding:.55rem .85rem .5rem; border:1px solid rgba(255,255,255,.25); border-radius:12px; min-width:105px; backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); box-shadow:0 4px 12px -4px rgba(0,0,0,.35); position:relative;} 
.mini-item::after {content:''; position:absolute; inset:0; border-radius:12px; background:linear-gradient(135deg,rgba(255,255,255,.35) 0%,rgba(255,255,255,0) 60%); opacity:.15; pointer-events:none;}
.mini-label {display:block; font-size:.55rem; text-transform:uppercase; letter-spacing:1.2px; opacity:.85; font-weight:600; margin-bottom:.15rem;}
.mini-value {display:block; font-size:.95rem; font-weight:700; letter-spacing:.5px;}
.dark .btn-back-solid {background:#1e293b; color:#e2e8f0; border-color:#334155;}
.dark .btn-back-solid:hover {background:#3b82f6; border-color:#1d4ed8;}
.dark .theme-toggle {background:rgba(255,255,255,.12);}
.dark .theme-toggle:hover {background:rgba(255,255,255,.25);} 
.dark .mini-item {background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.18);} 

@media (max-width: 768px){
  .hero-grid {flex-direction:column;}
  .hero-top-row {justify-content:space-between;}
  .hero-mini-stats {gap:.5rem;}
  .mini-item {min-width:calc(50% - .5rem);}
}

@media (max-width: 480px){
  .mini-item {min-width:100%;}
  .btn-back-solid span {display:none;}
}

.hero-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
}

.hero-back-btn {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  background: rgba(255, 255, 255, 0.1);
  color: white;
  text-decoration: none;
/* Optional: Deprecate old hero-back-btn styles */
.hero-back-btn {
  /* Deprecated styles can be removed in future versions */
}

/* Hero Back Button - Modern Design */
.back-button-wrapper {
  position: absolute;
  top: 1.5rem;
  left: 1rem;
  z-index: 999;
}

.back-btn-hero {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.25rem;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 2px solid rgba(37, 99, 235, 0.3);
  border-radius: 50px;
  color: #1e293b;
  text-decoration: none;
  font-weight: 600;
  font-size: 0.875rem;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15), 
              0 2px 8px rgba(37, 99, 235, 0.1);
  transition: all 0.3s ease;
}

.back-btn-hero:hover {
  transform: translateY(-2px);
  background: #2563eb;
  border-color: #1d4ed8;
  color: #ffffff;
  box-shadow: 0 12px 40px rgba(37, 99, 235, 0.4), 
              0 4px 16px rgba(37, 99, 235, 0.2);
}

.back-btn-hero i {
  font-size: 0.875rem;
}

.back-btn-hero span {
  font-weight: 600;
}

/* Dark mode */
.dark .back-btn-hero {
  background: rgba(30, 41, 59, 0.95);
  border-color: rgba(96, 165, 250, 0.3);
  color: #e2e8f0;
}

.dark .back-btn-hero:hover {
  background: #3b82f6;
  border-color: #2563eb;
  color: #ffffff;
}

/* Old floating-back styles removed - using back-btn-hero now */

.theme-toggle {
  width: 44px;
  height: 44px;
  border: none;
  background: rgba(255, 255, 255, 0.1);
  color: white;
  border-radius: 50%;
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  cursor: pointer;
}

.theme-toggle:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.1);
}

.hero-title {
  text-align: center;
}

.hero-heading {
  font-size: 3rem;
  font-weight: 800;
  margin-bottom: 0.5rem;
  background: linear-gradient(135deg, white 0%, rgba(255, 255, 255, 0.8) 100%);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

.hero-subtitle {
  font-size: 1.2rem;
  margin-bottom: 2rem;
  opacity: 0.9;
  font-weight: 400;
}

.hero-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 50px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

/* Unified Back Button */
.btn-back-nav{display:inline-flex;align-items:center;gap:.55rem;background:linear-gradient(135deg,#f8f9fa,#e9ecef);border:1px solid #dee2e6;color:#343a40;font-weight:600;padding:.55rem 1rem;border-radius:50px;text-decoration:none;box-shadow:0 2px 4px rgba(0,0,0,.06);transition:.25s ease;position:relative;overflow:hidden}
.btn-back-nav .icon{display:inline-flex;width:1.1rem;height:1.1rem;align-items:center;justify-content:center;border-radius:50%;background:#0d6efd;color:#fff;font-size:.6rem;box-shadow:0 0 0 3px rgba(13,110,253,.15)}
.btn-back-nav:hover{transform:translateY(-2px);box-shadow:0 6px 18px -4px rgba(0,0,0,.15);color:#0d6efd;border-color:#cfd4da}
.btn-back-nav:active{transform:translateY(0)}
.dark .btn-back-nav{background:linear-gradient(135deg,#252a31,#1e2227);border-color:#343a40;color:#e9ecef}
.dark .btn-back-nav .icon{background:#4dabf7;box-shadow:0 0 0 3px rgba(77,171,247,.2)}
.dark .btn-back-nav:hover{color:#4dabf7;border-color:#3a4047}
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  align-items: end;
  flex: 1;
}

.date-filters {
  display: flex;
  gap: 1rem;
  align-items: end;
}

.date-input-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.date-label {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-secondary);
}

.date-input {
  padding: 0.75rem;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  background: var(--light-card);
  color: var(--text-primary);
  transition: all 0.3s ease;
  font-size: 0.875rem;
}

.dark .date-input {
  background: var(--dark-bg);
}

.date-input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.filter-btn, .clear-btn {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  font-weight: 500;
  text-decoration: none;
  transition: all 0.3s ease;
  border: none;
  cursor: pointer;
}

.filter-btn {
  background: var(--primary-color);
  color: white;
}

.filter-btn:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.clear-btn {
  background: #ef4444;
  color: white;
}

.clear-btn:hover {
  background: #dc2626;
  color: white;
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.quick-filters {
  display: flex;
  gap: 0.5rem;
}

.quick-filter-btn {
  padding: 0.5rem 1rem;
  border: 2px solid var(--border-color);
  background: var(--light-card);
  color: var(--text-primary);
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.dark .quick-filter-btn {
  background: var(--dark-bg);
}

.quick-filter-btn:hover {
  border-color: var(--primary-color);
  background: var(--primary-color);
  color: white;
  transform: translateY(-2px);
}

.threshold-control {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.threshold-label {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-secondary);
  white-space: nowrap;
}

.threshold-input-group {
  display: flex;
  align-items: center;
  background: var(--light-card);
  border: 2px solid var(--border-color);
  border-radius: 8px;
  overflow: hidden;
  transition: all 0.3s ease;
}

.dark .threshold-input-group {
  background: var(--dark-bg);
}

.threshold-input-group:focus-within {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.threshold-input {
  width: 60px;
  padding: 0.75rem;
  border: none;
  background: transparent;
  color: var(--text-primary);
  font-weight: 600;
  text-align: center;
}

.threshold-input:focus {
  outline: none;
}

.threshold-unit {
  padding: 0.75rem;
  background: var(--border-color);
  color: var(--text-secondary);
  font-weight: 600;
  font-size: 0.875rem;
}

.dark .threshold-unit {
  background: var(--dark-border);
}

/* Statistics Cards - New Modern Design */
.stats-section {
  margin-bottom: 2rem;
}

.stat-card-modern {
  background: #ffffff;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  overflow: hidden;
  height: 100%;
}

.stat-card-modern:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.stat-header {
  display: flex;
  align-items: center;
  padding: 1.25rem 1.5rem;
  gap: 1rem;
}

.stat-icon-wrapper {
  width: 48px;
  height: 48px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  color: white;
  flex-shrink: 0;
}

.stat-card-modern.primary .stat-icon-wrapper {
  background: linear-gradient(135deg, #667eea, #764ba2);
}

.stat-card-modern.success .stat-icon-wrapper {
  background: linear-gradient(135deg, #4ade80, #22c55e);
}

.stat-card-modern.warning .stat-icon-wrapper {
  background: linear-gradient(135deg, #f59e0b, #d97706);
}

.stat-card-modern.info .stat-icon-wrapper {
  background: linear-gradient(135deg, #06b6d4, #0891b2);
}

.stat-main {
  flex: 1;
}

.stat-card-modern .stat-value {
  font-size: 1.875rem;
  font-weight: 700;
  color: #1e293b;
  line-height: 1.2;
  margin-bottom: 0.25rem;
}

.stat-card-modern .stat-label {
  font-size: 0.875rem;
  font-weight: 500;
  color: #64748b;
  margin: 0;
}

.dark .stat-card-modern {
  background: #1e293b;
  border-color: #334155;
}

.dark .stat-card-modern .stat-value {
  color: #f1f5f9;
}

.dark .stat-card-modern .stat-label {
  color: #94a3b8;
}

/* Old Statistics Grid - Keep for compatibility */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 2rem;
  margin-bottom: 3rem;
}

.stat-card {
  background: var(--light-card);
  border-radius: 16px;
  padding: 2rem;
  position: relative;
  overflow: hidden;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  transition: all 0.3s ease;
}

.dark .stat-card {
  background: var(--dark-card);
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-xl);
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
}

.stat-card.total-attempts::before {
  background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
}

.stat-card.average-score::before {
  background: linear-gradient(90deg, var(--success-color), #34d399);
}

.stat-card.best-score::before {
  background: linear-gradient(90deg, var(--warning-color), #fbbf24);
}

.stat-card.pass-rate::before {
  background: linear-gradient(90deg, var(--info-color), #22d3ee);
}

.stat-icon {
  width: 60px;
  height: 60px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  color: white;
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow-md);
}

.total-attempts .stat-icon {
  background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
}

.average-score .stat-icon {
  background: linear-gradient(135deg, var(--success-color), #059669);
}

.best-score .stat-icon {
  background: linear-gradient(135deg, var(--warning-color), #d97706);
}

.pass-rate .stat-icon {
  background: linear-gradient(135deg, var(--info-color), #0891b2);
}

.stat-value-row {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 0.5rem;
}

.stat-value {
  font-size: 2.5rem;
  font-weight: 800;
  color: var(--text-primary);
  line-height: 1;
}

.stat-delta {
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 600;
}

.stat-delta.positive {
  background: rgba(16, 185, 129, 0.1);
  color: var(--success-color);
}

.stat-delta.negative {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger-color);
}

.stat-label {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 1rem;
}

.stat-sparkline {
  width: 100%;
  height: 40px;
  opacity: 0.7;
}

.stat-decoration {
  position: absolute;
  top: 1rem;
  right: 1rem;
  width: 100px;
  height: 100px;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(99, 102, 241, 0.02));
  border-radius: 50%;
  transform: translate(30%, -30%);
}

/* Results Section */
.results-section {
  background: var(--light-card);
  border-radius: 16px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  overflow: hidden;
  margin-bottom: 3rem;
}

.dark .results-section {
  background: var(--dark-card);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 2rem;
  border-bottom: 1px solid var(--border-color);
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(99, 102, 241, 0.02));
}

.section-title {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.section-title i {
  color: var(--primary-color);
  font-size: 1.5rem;
}

.section-title h2 {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
}

.sort-hint {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.sort-hint i {
  color: var(--primary-color);
}

.results-table-container {
  padding: 2rem;
}

/* Chart Section */
.chart-section {
  background: var(--light-card);
  border-radius: 16px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  overflow: hidden;
  margin-bottom: 3rem;
}

.dark .chart-section {
  background: var(--dark-card);
}

.chart-header {
  padding: 2rem 2rem 1rem;
  border-bottom: 1px solid var(--border-color);
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(99, 102, 241, 0.02));
}

.chart-title {
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
}

.chart-title i {
  color: var(--primary-color);
}

.chart-container {
  padding: 2rem;
  height: 400px;
}

#statsChart {
  width: 100% !important;
  height: 100% !important;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  color: var(--text-secondary);
}

.empty-icon {
  width: 80px;
  height: 80px;
  margin: 0 auto 2rem;
  background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  color: white;
  box-shadow: var(--shadow-lg);
}

.empty-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 1rem;
}

.empty-description {
  font-size: 1rem;
  color: var(--text-secondary);
  max-width: 400px;
  margin: 0 auto;
}

/* Table Styles */
.table {
  color: var(--text-primary);
}

.table thead th {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(99, 102, 241, 0.05)) !important;
  border: none;
  font-weight: 600;
  color: var(--text-primary);
  padding: 1rem;
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.table tbody tr {
  border: none;
  transition: all 0.3s ease;
}

.table tbody tr:hover {
  background: rgba(99, 102, 241, 0.05) !important;
  transform: translateX(4px);
}

.table tbody td {
  padding: 1rem;
  border: none;
  vertical-align: middle;
}

.progress-thin {
  height: 24px;
  background: rgba(0, 0, 0, 0.05);
  border-radius: 12px;
  overflow: hidden;
  position: relative;
}

.dark .progress-thin {
  background: rgba(255, 255, 255, 0.1);
}

.progress-bar {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: 600;
  color: white;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
}

.percent-bar.bg-success {
  background: linear-gradient(90deg, var(--success-color), #34d399) !important;
}

.percent-bar.bg-info {
  background: linear-gradient(90deg, var(--info-color), #22d3ee) !important;
}

.percent-bar.bg-warning {
  background: linear-gradient(90deg, var(--warning-color), #fbbf24) !important;
}

.percent-bar.bg-danger {
  background: linear-gradient(90deg, var(--danger-color), #f87171) !important;
}

/* Filter Section - Modern Design */
.filter-section-modern {
  margin-bottom: 2rem;
}

.filter-card {
  background: #ffffff;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  overflow: hidden;
}

.filter-header {
  background: linear-gradient(135deg, #f8fafc, #f1f5f9);
  padding: 1rem 1.5rem;
  border-bottom: 1px solid #e2e8f0;
}

.filter-title {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
  color: #334155;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.filter-title i {
  color: #6366f1;
}

.filter-form-modern {
  padding: 1.5rem;
}

.quick-filter-group {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.quick-filter-chip {
  padding: 0.375rem 0.75rem;
  border: 1px solid #d1d5db;
  background: #ffffff;
  color: #6b7280;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.quick-filter-chip:hover {
  border-color: #6366f1;
  color: #6366f1;
  background: #f0f9ff;
}

.quick-filter-chip.active {
  background: #6366f1;
  color: white;
  border-color: #6366f1;
}

.filter-actions {
  display: flex;
  gap: 0.75rem;
  align-items: center;
  padding-top: 1rem;
  border-top: 1px solid #f1f5f9;
}

.dark .filter-card {
  background: #1e293b;
  border-color: #334155;
}

.dark .filter-header {
  background: linear-gradient(135deg, #334155, #1e293b);
  border-color: #475569;
}

.dark .filter-title {
  color: #f1f5f9;
}

.dark .quick-filter-chip {
  background: #334155;
  border-color: #475569;
  color: #cbd5e1;
}

.dark .quick-filter-chip:hover {
  border-color: #6366f1;
  color: #6366f1;
  background: #1e1b4b;
}

.dark .filter-actions {
  border-color: #334155;
}

/* Responsive Design */
@media (max-width: 768px) {
  .hero-heading {
    font-size: 2rem;
  }
  
  .hero-subtitle {
    font-size: 1rem;
  }
  
  .filter-form {
    flex-direction: column;
    gap: 1.5rem;
  }
  
  .date-filters {
    flex-direction: column;
    width: 100%;
  }
  
  .quick-filters {
    justify-content: center;
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }
  
  .stat-card {
    padding: 1.5rem;
  }
  
  .stat-value {
    font-size: 2rem;
  }
  
  .section-header {
    flex-direction: column;
    gap: 1rem;
    text-align: center;
  }
  
  .results-table-container,
  .chart-container {
    padding: 1rem;
  }
  
  .chart-container {
    height: 300px;
  }
  
  .table thead {
    display: none;
  }
  
  .table tbody tr {
    display: block;
    margin-bottom: 1rem;
    background: var(--light-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1rem;
    box-shadow: var(--shadow-sm);
  }
  
  .dark .table tbody tr {
    background: var(--dark-bg);
  }
  
  .table tbody td {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border: none;
  }
  
  .table tbody td::before {
    content: attr(data-label);
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.875rem;
  }
}

/* Animation Classes */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-in-up {
  animation: fadeInUp 0.6s ease-out;
}

@keyframes pulse {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
}

.animate-pulse {
  animation: pulse 2s infinite;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  const root=document.documentElement;const darkBtn=document.getElementById('darkToggle');
  function applyDark(v){if(v){root.classList.add('dark');localStorage.setItem('pa_dark','1');}else{root.classList.remove('dark');localStorage.removeItem('pa_dark');}}
  applyDark(localStorage.getItem('pa_dark')==='1');
  if(darkBtn) darkBtn.addEventListener('click',()=>applyDark(!root.classList.contains('dark')));
})();

(function(){ // pass threshold live recolor
  const thrInput=document.getElementById('passThreshold');
  if(!thrInput) return; function recolor(){const thr=parseFloat(thrInput.value)||0;document.querySelectorAll('.pass-badge').forEach(b=>{const p=parseFloat(b.dataset.percent)||0;b.className='badge pass-badge '+(p>=thr?'bg-success':'bg-danger');});document.querySelectorAll('.percent-bar').forEach(pb=>{const p=parseFloat(pb.dataset.percent)||0;let cls='bg-danger';if(p>=thr){cls=p>=85?'bg-success':p>=70?'bg-info':'bg-warning';}pb.className='progress-bar percent-bar '+cls;});}
  thrInput.addEventListener('input',recolor);recolor();
})();

(function(){ // quick filters
  const btns=document.querySelectorAll('.quick-filter-chip[data-range]');
  const start=document.querySelector('input[name=start]'); const end=document.querySelector('input[name=end]');
  function fmt(d){return d.toISOString().slice(0,10);} 
  btns.forEach(b=>b.addEventListener('click',()=>{const r=b.dataset.range; if(r==='all'){start.value='';end.value='';}else{const now=new Date();end.value=fmt(now);const days=parseInt(r);const past=new Date(now.getTime()- (days-1)*86400000);start.value=fmt(past);} b.closest('form').submit();}));
})();

(function(){ // load more pagination (15)
  const rows=[...document.querySelectorAll('#attemptBody tr')]; const load=document.getElementById('loadMore');
  let shown=15; function upd(){rows.forEach((r,i)=>{r.style.display = i<shown?'' :'none';}); if(shown>=rows.length) load.style.display='none';}
  if(rows.length<=15) load.style.display='none'; else upd();
  load.addEventListener('click',()=>{shown+=15;upd();});
})();

(function(){ // sortable table
  const tbl=document.getElementById('attemptsTbl'); if(!tbl) return; const tbody=tbl.querySelector('tbody'); let dir=1, lastKey=null;
  function getVal(cell,type){const t=cell.innerText.trim(); if(type==='num') return parseFloat(t)||0; if(type==='date') return new Date(t.replace(/-/g,'/')).getTime(); return t.toLowerCase();}
  tbl.querySelectorAll('thead th[data-sort]').forEach((th,idx)=>{th.style.cursor='pointer'; th.addEventListener('click',()=>{const type=th.dataset.sort; const rows=[...tbody.querySelectorAll('tr')]; const key=idx; dir = (lastKey===key)? -dir : 1; lastKey=key; rows.sort((a,b)=>{const av=getVal(a.children[key],type), bv=getVal(b.children[key],type); if(av<bv) return -dir; if(av>bv) return dir; return 0;}); rows.forEach((r,i)=>{tbody.appendChild(r); r.querySelector('.row-index').innerText=i+1;});});});
})();

(function(){ // sparkline
  const canvases=document.querySelectorAll('.spark'); canvases.forEach(c=>{const pts=(c.dataset.points||'').split(',').filter(Boolean).map(Number); if(pts.length<2) return; const w=c.clientWidth||120, h=c.clientHeight||26; c.width=w; c.height=h; const ctx=c.getContext('2d'); const max=Math.max(...pts), min=Math.min(...pts); const range=(max-min)||1; ctx.lineWidth=2; ctx.strokeStyle='#10b981'; ctx.beginPath(); pts.forEach((p,i)=>{const x=i/(pts.length-1)*w; const y=h - ((p-min)/range)*h; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);}); ctx.stroke(); ctx.fillStyle='rgba(16,185,129,0.18)'; ctx.lineTo(w,h); ctx.lineTo(0,h); ctx.closePath(); ctx.fill();});
})();

(function(){ // attempt detail modal (client only summary)
  if(typeof bootstrap==='undefined') return; const modalEl=document.getElementById('attemptModal'); if(!modalEl) return; let modal; try{modal=new bootstrap.Modal(modalEl);}catch(e){console.warn('Bootstrap modal init failed',e);return;} const rows=[...document.querySelectorAll('#attemptBody tr')];
  rows.forEach(r=>{const btn=r.querySelector('.attempt-detail'); if(!btn) return; btn.addEventListener('click',()=>{try{const title=r.querySelector('.test-title').innerText; const percent=r.querySelector('.percent-bar').dataset.percent; const score=r.querySelector('.pass-badge').innerText.trim(); const correct=r.querySelector('.text-success').innerText; const total=r.querySelector('.total-q').innerText; const time=r.querySelector('.time-cell').dataset.time; document.getElementById('attemptMeta').innerHTML=`<strong>${title}</strong><br>Ball: ${score} | Foiz: ${percent}% | To'g'ri: ${correct}/${total} | ${time}`; document.getElementById('attemptQuestions').innerHTML='<div class="list-group-item">Savol tafsilotlari (backend API kerak) â€“ hozircha soddalashtirilgan.</div>'; modal.show();}catch(e){console.error('Attempt modal error',e);}});});
})();

(function(){ // main chart with debug
  try{
    const raw = {{ items_js }}; console.log('Chart raw data:', raw);
    if(!raw||!raw.length){console.log('Chart: no data'); return;} 
    const labels=raw.map(r=>r.test_title||''); 
    const perc=raw.map(r=>Number(r.percent)||0); 
    const scores=raw.map(r=>Number(r.score)||0); 
    const canvas=document.getElementById('statsChart'); if(!canvas){console.warn('Chart canvas missing'); return;} const ctx=canvas.getContext('2d');
    if(window.Chart){
      new Chart(ctx,{data:{labels,datasets:[
        {type:'bar',label:'Ball',data:scores,backgroundColor:'rgba(16,185,129,0.55)',borderColor:'#10b981',borderWidth:1,yAxisID:'yScore'},
        {type:'line',label:'Foiz %',data:perc,borderColor:'#6366f1',backgroundColor:'rgba(99,102,241,0.25)',borderWidth:2,tension:.35,pointRadius:4,pointBackgroundColor:'#6366f1',yAxisID:'yPercent'}
      ]},options:{maintainAspectRatio:false,responsive:true,interaction:{mode:'index',intersect:false},plugins:{legend:{labels:{font:{size:11}}},tooltip:{callbacks:{label:e=>e.dataset.label+': '+e.formattedValue+(e.dataset.yAxisID==='yPercent'?'%':'')}}},scales:{yPercent:{type:'linear',position:'right',beginAtZero:true,max:100,grid:{drawOnChartArea:false},ticks:{callback:v=>v+'%'}},yScore:{type:'linear',position:'left',beginAtZero:true,suggestedMax:Math.max(...scores,1)},x:{ticks:{autoSkip:false,maxRotation:50,minRotation:0}}}}});
    } else { console.error('Chart.js not loaded'); }
  }catch(err){console.error('Chart init error', err);}
})();

// ===== Per-test filtering & overall aggregates =====
(function(){
  const items = (()=>{try{return {{ items_js }};}catch(e){return [];}})();
  const selectEl = document.getElementById('testSelect');
  if(!selectEl||!items.length) return;
  const attemptRows = Array.from(document.querySelectorAll('#attemptBody tr'));
  const passThreshold = Number({{ personal_stats.pass_threshold }});
  function calcAgg(list){
    if(!list.length) return {attempts:0, avg:0, best:0, pass:0};
    const attempts = list.length;
    const avg = (list.reduce((s,o)=>s+ (o.percent||0),0)/attempts).toFixed(1);
    const best = Math.max(...list.map(o=>o.percent||0)).toFixed(1);
    const passCount = list.filter(o=> (o.percent||0) >= passThreshold).length;
    const pass = ((passCount/attempts)*100).toFixed(1);
    return {attempts, avg, best, pass};
  }
  function renderOverall(agg){
    document.getElementById('overallAttempts').textContent=agg.attempts;
    document.getElementById('overallAvg').textContent=agg.avg+'%';
    document.getElementById('overallBest').textContent=agg.best+'%';
    document.getElementById('overallPass').textContent=agg.pass+'%';
  }
  function apply(){
    const sel = selectEl.value;
    let filtered;
    if(sel==='__all__') filtered = items; else filtered = items.filter(i=>String(i.test_id)===String(sel));
    // Toggle rows
    attemptRows.forEach(r=>{
      const idx = Number(r.dataset.idx);
      const it = items[idx];
      r.style.display = (!it|| (sel!=='__all__' && String(it.test_id)!==String(sel)))? 'none':'';
    });
    // Renumber visible
    let c=0; attemptRows.forEach(r=>{ if(r.style.display!=='none'){ c++; r.querySelector('.row-index').textContent=c; }});
    renderOverall(calcAgg(filtered));
  }
  selectEl.addEventListener('change', apply);
  // default initial
  apply();
})();
</script>
{% endblock %}
