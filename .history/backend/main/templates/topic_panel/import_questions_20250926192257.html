{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <h3 class="mb-3">Savollarni import qilish: {{ topic.title }}</h3>
  <p class="text-muted">CSV yoki {% if has_openpyxl %}XLSX{% else %}XLSX (openpyxl o'rnatilsa){% endif %} fayl yuklang.
  <br>Ustunlar: text, question_type (single|multi), option1, correct1, option2, correct2, ... option6, correct6</p>
  <div class="card p-3 mb-4">
    <form id="importForm" enctype="multipart/form-data" class="mb-3">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <input type="file" name="file" accept=".csv,.xlsx" class="form-control" style="max-width:320px" required>
        <button class="btn btn-primary" type="submit"><i class="fas fa-upload me-1"></i>Yuklash</button>
        <a href="/media/sample_topic_import.csv" class="btn btn-outline-secondary"><i class="fas fa-file-csv me-1"></i>Namunaviy CSV</a>
      </div>
    </form>
    <div class="progress" style="height:10px; display:none;" id="uploadBarWrap">
      <div class="progress-bar progress-bar-striped progress-bar-animated" id="uploadBar" style="width:0%"></div>
    </div>
    <div id="importResult" class="mt-3"></div>
  </div>
</div>
<script>
const form = document.getElementById('importForm');
const barWrap = document.getElementById('uploadBarWrap');
const bar = document.getElementById('uploadBar');
form.addEventListener('submit', (e)=>{
  e.preventDefault();
  const fd = new FormData(form);
  const xhr = new XMLHttpRequest();
  const resBox = document.getElementById('importResult');
  resBox.innerHTML = '';
  barWrap.style.display='block';
  bar.style.width='0%';
  xhr.open('POST','');
  xhr.setRequestHeader('X-CSRFToken', getCsrf());
  xhr.upload.onprogress = (ev)=>{
    if(ev.lengthComputable){
      const pct = Math.round((ev.loaded/ev.total)*100);
      bar.style.width = pct+'%';
    }
  };
  xhr.onreadystatechange = ()=>{
    if(xhr.readyState===4){
      if(xhr.status>=200 && xhr.status<300){
        try { const data = JSON.parse(xhr.responseText);
          let html = `<div class='alert alert-success'>Yaratildi: ${data.created}. Qatorlar: ${data.total_rows}</div>`;
          if(data.errors && data.errors.length){
            html += '<div class="alert alert-warning"><strong>Xatoliklar:</strong><ul>' + data.errors.map(e=>`<li>${e}</li>`).join('') + '</ul></div>';
          }
          resBox.innerHTML = html;
        } catch(e){
          resBox.innerHTML = '<div class="alert alert-danger">JSON parse xatolik</div>';
        }
      } else {
        try { const data = JSON.parse(xhr.responseText); resBox.innerHTML = `<div class='alert alert-danger'>Xatolik: ${data.error||'Noma\'lum'}</div>`; } catch(e){ resBox.innerHTML='<div class="alert alert-danger">Server xato</div>'; }
      }
      setTimeout(()=>{ barWrap.style.display='none'; }, 1200);
    }
  };
  xhr.send(fd);
});
function getCsrf(){
  return document.cookie.split('; ').find(r=>r.startsWith('csrftoken='))?.split('=')[1];
}
</script>
{% endblock %}
