{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <h3 class="mb-3">Savollarni import qilish: {{ topic.title }}</h3>
  <p class="text-muted">CSV yoki {% if has_openpyxl %}XLSX{% else %}XLSX (openpyxl o'rnatilsa){% endif %} fayl yuklang.
  <br>Ustunlar: text, question_type (single|multi), option1, correct1, option2, correct2, ... option6, correct6</p>
  <div class="card p-3 mb-4">
    <form id="importForm" enctype="multipart/form-data">
      <input type="file" name="file" accept=".csv,.xlsx" class="form-control mb-2" required>
      <button class="btn btn-primary" type="submit">Yuklash</button>
      <a href="/media/sample_topic_import.csv" class="btn btn-outline-secondary ms-2">Namunaviy CSV</a>
    </form>
    <div id="importResult" class="mt-3"></div>
  </div>
</div>
<script>
const form = document.getElementById('importForm');
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(form);
  const resBox = document.getElementById('importResult');
  resBox.innerHTML = '<div class="alert alert-info">Yuborilmoqda...</div>';
  try {
    const resp = await fetch('', {method:'POST', headers:{'X-CSRFToken': getCsrf()}, body: fd});
    const data = await resp.json();
    if(!resp.ok){
      resBox.innerHTML = `<div class='alert alert-danger'>Xatolik: ${data.error||'Noma\'lum'}</div>`;
      return;
    }
    let html = `<div class='alert alert-success'>Yaratildi: ${data.created}. Qatorlar: ${data.total_rows}</div>`;
    if(data.errors && data.errors.length){
      html += '<div class="alert alert-warning"><strong>Xatoliklar:</strong><ul>' + data.errors.map(e=>`<li>${e}</li>`).join('') + '</ul></div>';
    }
    resBox.innerHTML = html;
  } catch(err){
    resBox.innerHTML = '<div class="alert alert-danger">Server xatolik</div>';
  }
});
function getCsrf(){
  return document.cookie.split('; ').find(r=>r.startsWith('csrftoken='))?.split('=')[1];
}
</script>
{% endblock %}
