{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container-fluid" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 0;">
  <div class="row h-100 align-items-center justify-content-center" style="min-height: 100vh;">
    <div class="col-lg-8 col-xl-6">
      <div class="card shadow-lg border-0" style="border-radius: 20px; backdrop-filter: blur(10px); background: rgba(255,255,255,0.95);">
        <div class="card-header bg-transparent border-0 text-center pt-4 pb-2">
          <h2 class="mb-1" style="color: #2d3748; font-weight: 700;">
            <i class="fas fa-play-circle text-primary me-2"></i>{{ test.title }}
          </h2>
          <p class="text-muted mb-0" style="font-size: 1.1em;">Testni boshlashdan oldin videoni tomosha qiling</p>
        </div>
        <div class="card-body p-4">
          <div class="position-relative mb-4">
            <div class="ratio ratio-16x9 rounded-4 overflow-hidden shadow-lg" style="background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);">
              {% if embed_url %}
                {% if 'youtube.com/embed' in embed_url %}
                  <iframe src="{{ embed_url }}" title="YouTube video" 
                          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                          allowfullscreen loading="lazy" referrerpolicy="strict-origin-when-cross-origin"
                          style="border-radius: 16px;"></iframe>
                {% else %}
                  <iframe src="{{ embed_url }}" allowfullscreen loading="lazy" style="border-radius: 16px;"></iframe>
                {% endif %}
              {% elif video.video_file %}
                <video controls style="width:100%; border-radius: 16px;" preload="metadata">
                  <source src="{{ video.video_file.url }}">
                </video>
              {% else %}
                <div class="d-flex align-items-center justify-content-center h-100 text-white">
                  <div class="text-center">
                    <i class="fas fa-video-slash fa-3x mb-3 opacity-75"></i>
                    <h5>Video topilmadi</h5>
                    <p class="mb-0 opacity-75">Ushbu test uchun video yuklanmagan</p>
                  </div>
                </div>
              {% endif %}
            </div>
            <div class="position-absolute top-0 start-0 m-3">
              <span class="badge bg-primary px-3 py-2 rounded-pill">
                <i class="fas fa-clock me-1"></i>Kirish videosi
              </span>
            </div>
          </div>
          
          <div class="text-center">
            <button id="continueBtn" class="btn btn-lg px-5 py-3 position-relative overflow-hidden" 
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 50px; color: white; font-weight: 600; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4); transition: all 0.3s ease;">
              <span class="position-relative z-1">
                <i class="fas fa-rocket me-2"></i>Testni boshlash
              </span>
            </button>
            <div class="mt-3">
              <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Video ko'rib bo'lgach test avtomatik ochiladi
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
#continueBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6) !important;
}
#continueBtn:active {
  transform: translateY(0);
}
#continueBtn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none !important;
}

/* Loading animation */
.btn-loading::after {
  content: '';
  position: absolute;
  width: 16px;
  height: 16px;
  top: 50%;
  left: 50%;
  margin-left: -8px;
  margin-top: -8px;
  border: 2px solid transparent;
  border-top-color: #ffffff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.fade-in {
  animation: fadeIn 0.6s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
<script>
const btn = document.getElementById('continueBtn');
btn.addEventListener('click', async ()=>{
  const resp = await fetch('{% url 'topic:video_seen' test.id %}', {method:'GET'});
  const data = await resp.json();
  if(data.ok){
    window.location.href = '{% url 'topic:start_test' test.id %}';
  }
});
</script>
{% endblock %}
