<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>Savol qo‘shish</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
    font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
    background: url('/static/main/1.png') no-repeat center center fixed;
    background-size: cover;
    margin: 0;
    padding: 0;
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
}
    /* --- Fancy multi-select (groups) reused from controller add_test --- */
    .ms-container { position: relative; }
    .ms-control { display:flex; align-items:center; gap:8px; min-height:48px; width:100%; padding:10px 12px; border-radius:12px; cursor:pointer; background: rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:#fff; transition: all .25s ease; }
    .ms-control:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.35); }
    .ms-placeholder { opacity:.8; }
    .ms-chips { display:flex; flex-wrap:wrap; gap:6px; }
    .ms-chip { background: rgba(0,0,0,0.25); border:1px solid rgba(255,255,255,0.25); color:#fff; padding:4px 8px; border-radius:999px; font-size:.85rem; }
    .ms-caret { margin-left:auto; opacity:.8; }
    .ms-dropdown { position:absolute; left:0; right:0; top: calc(100% + 8px); z-index:20; display:none; background: rgba(20,20,20,0.92); border:1px solid rgba(255,255,255,0.18); border-radius:12px; overflow:hidden; box-shadow:0 12px 35px rgba(0,0,0,0.35); }
    .ms-open .ms-dropdown { display:block; }
    .ms-toolbar { display:flex; gap:6px; padding:8px; border-bottom:1px solid rgba(255,255,255,0.08); align-items:center; }
    .ms-btn { background: rgba(255,255,255,0.08); color:#fff; border:1px solid rgba(255,255,255,0.18); border-radius:8px; padding:6px 10px; font-size:.8rem; cursor:pointer; }
    .ms-btn:hover { background: rgba(255,255,255,0.14); }
    .ms-count { opacity:.7; font-size:.85rem; margin-left:auto; }
    .ms-search { width:100%; padding:8px 10px; background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.18); border-radius:8px; color:#fff; }
    .ms-list { max-height: 240px; overflow:auto; padding:4px 0; }
    .ms-option { display:flex; align-items:center; gap:10px; padding:8px 10px; color:#fff; }
    .ms-option:hover { background: rgba(255,255,255,0.06); }

/* Animated background particles */
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)" opacity="0.6"><animate attributeName="cy" values="20;80;20" dur="4s" repeatCount="indefinite"/></circle><circle cx="80" cy="80" r="3" fill="rgba(255,255,255,0.08)" opacity="0.4"><animate attributeName="cx" values="80;20;80" dur="6s" repeatCount="indefinite"/></circle><circle cx="50" cy="50" r="1.5" fill="rgba(255,255,255,0.12)" opacity="0.8"><animate attributeName="r" values="1.5;3;1.5" dur="3s" repeatCount="indefinite"/></circle></svg>') repeat;
    pointer-events: none;
    z-index: 1;
}
.container {
    position: relative;
    z-index: 2;
    max-width: 730px;
    margin: 38px auto;
    padding: 42px 30px 18px 30px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(20px);
    border-radius: 22px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    animation: fadeIn 0.7s;
}
@keyframes fadeIn { from { opacity: 0;} to { opacity: 1;} }
h2 {
    text-align: center;
    color: #232e3a;
    font-size: 2.26rem;
    font-weight: 700;
    margin-bottom: 32px;
    letter-spacing: 0.7px;
}
label {
    display: block;
    margin-top: 20px;
    margin-bottom: 7px;
    font-weight: 600;
    color: #23334b;
    font-size: 1.08rem;
}
select, input[type="number"], textarea, input[type="file"] {
    width: 100%;
    padding: 13px 14px;
    border: 1.7px solid #e2e8f0;
    border-radius: 11px;
    font-size: 1.12rem;
    background: #f6fafd;
    margin-bottom: 2px;
    transition: border-color 0.19s, box-shadow 0.19s;
}
select:focus, textarea:focus, input[type="number"]:focus {
    border-color: #1976d2;
    outline: none;
    box-shadow: 0 0 0 2px #e3f0fc;
    background: #fff;
}
textarea {
    resize: vertical;
    min-height: 85px;
    font-size: 1.18rem;
}
.textarea-wrapper {
    position: relative;
    width: 100%;
}
.formula-calc-btn {
    position: absolute;
    right: 12px;
    top: 12px;
    width: 36px;
    height: 36px;
    background: #e3f2fd;
    border: 1.5px solid #b6dafc;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.15s;
    z-index: 10;
    box-shadow: 0 2px 8px 0 rgba(49,130,206,0.08);
}
.formula-calc-btn:hover { background: #bbdefb; }
.formula-calc-btn svg {
    width: 22px; height: 22px; color: #1976d2;
}
.formula-popup {
    display: none;
    position: absolute;
    left: 100%;
    top: 0;
    margin-left: 10px;
    background: #fff;
    border: 2px solid #b6dafc;
    box-shadow: 0 4px 22px 0 rgba(25, 118, 210, 0.18);
    border-radius: 14px;
    padding: 15px 14px 12px 14px;
    min-width: 320px;
    max-width: 470px;
    max-height: 340px;
    overflow-y: auto;
    grid-template-columns: repeat(auto-fill, minmax(56px,1fr));
    display: grid;
    grid-gap: 7px;
    z-index: 99;
}
.formula-popup.open {
    display: grid;
}
.formula-popup button {
    background: #f7fbff;
    border: 1.2px solid #b6dafc;
    color: #1976d2;
    padding: 8px 10px;
    border-radius: 7px;
    font-size: 1.24rem;
    min-width: 38px;
    cursor: pointer;
    transition: background 0.14s, color 0.14s, box-shadow 0.13s;
    box-shadow: 0 1px 7px 0 rgba(25,118,210,0.06);
}
.formula-popup button:hover {
    background: #1976d2;
    color: #fff;
    border-color: #1976d2;
}
.preview-label {
    font-size: 1.04rem;
    color: #3d5068;
    margin-top: 12px;
    margin-bottom: 2px;
    font-weight: 500;
}
.preview-box {
    background: linear-gradient(90deg,#f5f7fa 0%, #e3f0fc 100%);
    min-height: 38px;
    padding: 13px 14px;
    border-radius: 8px;
    font-size: 1.28rem;
    color: #1a253c;
    margin-bottom: 10px;
    margin-top: 2px;
    border: 1.5px solid #e2e8f0;
    box-shadow: 0 2px 8px 0 rgba(31,38,135,0.06);
    overflow-x: auto;
    font-family: inherit;
}
button[type="submit"] {
    margin-top: 18px;
    width: 100%;
    padding: 15px;
    background: linear-gradient(90deg,#1976d2 0%, #42a5f5 100%);
    color: white;
    border: none;
    border-radius: 9px;
    font-size: 1.16rem;
    font-weight: 600;
    letter-spacing: 0.8px;
    cursor: pointer;
    box-shadow: 0 3px 14px 0 rgba(25, 118, 210, 0.15);
    transition: background 0.14s, box-shadow 0.14s;
}
button[type="submit"]:hover {
    background: linear-gradient(90deg,#1565c0 0%, #2196f3 100%);
    box-shadow: 0 6px 24px 0 rgba(25, 118, 210, 0.18);
}
.back-link {
    text-align: center;
    margin-top: 24px;
}
.back-link a {
    color: #1976d2;
    font-weight: 500;
    text-decoration: none;
    font-size: 1.08rem;
    letter-spacing: 0.3px;
    transition: color 0.13s;
}
.back-link a:hover {
    color: #0d47a1;
    text-decoration: underline;
}
.remove-variant-btn {
    margin-left: 5px;
    color: #dc3545;
    background: none;
    border: none;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    line-height: 18px;
    text-align: center;
    transition: background 0.15s, color 0.15s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}
.remove-variant-btn:hover {
    background: #f8d7da;
    color: #a71d2a;
}
.single-choice-row, .multiple-choice-row, .matching-row, .ordering-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 6px;
    background: #f5f8fd;
    border-radius: 7px;
    padding: 8px 10px 8px 10px;
    box-shadow: 0 1px 7px 0 rgba(49,130,206,0.04);
}
.single-choice-row input[type="text"],
.multiple-choice-row input[type="text"],
.matching-row input[type="text"],
.ordering-row input[type="text"] {
    flex: 1 1 auto;
    font-size: 1.08rem;
    background: #fff;
    border: 1.1px solid #c8d3e1;
    border-radius: 6px;
}
.variant-preview {
    margin-left: 12px;
    color: #1976d2;
    font-size: 1.18rem;
    min-width: 40px;
    min-height: 28px;
    font-family: inherit;
}
.variant-image-input { width:130px; font-size:.75rem; background:#fff; border:1px solid #c8d3e1; border-radius:6px; padding:4px; }
.img-thumb {max-height:42px; max-width:60px; display:inline-block; margin-left:6px; border:1px solid #e2e8f0; border-radius:4px; object-fit:cover;}
@media (max-width:700px){
    .container { max-width: 98vw; padding: 4vw 2vw 5vw 2vw;}
    h2 {font-size: 1.49rem;}
    .formula-popup {min-width: 96vw;}
    .formula-popup button, .preview-box {font-size: 1rem;}
    .single-choice-row, .multiple-choice-row, .matching-row, .ordering-row {font-size: 0.97rem; padding: 5px 6px;}
}
        /* === Enhanced variant cards === */
        .variant-card{position:relative;display:grid;grid-template-columns:1fr auto auto auto;grid-template-rows:auto auto;grid-column-gap:10px;align-items:start;padding:10px 12px 12px 12px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.25);background:rgba(255,255,255,0.35);backdrop-filter:blur(10px);border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,0.08);animation:fadeIn .35s ease;}
        .variant-card input[type=text]{background:#ffffffd9;border:1px solid #c9d6e5;border-radius:8px;padding:10px 12px;font-size:.95rem;box-shadow:0 1px 2px rgba(0,0,0,0.04);transition:border-color .18s,box-shadow .18s;width:100%;}
        .variant-card input[type=text]:focus{outline:none;border-color:#1976d2;box-shadow:0 0 0 2px #1976d233;}
        .variant-card .correct-box{display:flex;align-items:center;gap:4px;font-size:.8rem;margin-top:6px;color:#123;}
        .variant-card .remove-btn{position:absolute;top:6px;right:6px;background:rgba(255,255,255,0.55);border:1px solid #d33;padding:0 7px;height:26px;display:flex;align-items:center;justify-content:center;color:#d33;font-weight:700;font-size:15px;border-radius:8px;cursor:pointer;transition:.18s;}
        .variant-card .remove-btn:hover{background:#d33;color:#fff;}
        .variant-card .file-wrap{display:flex;align-items:center;gap:8px;margin-top:6px;}
        .variant-card .file-input{position:relative;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;background:#1976d2;color:#fff;border:none;padding:6px 12px;border-radius:7px;font-size:.72rem;cursor:pointer;font-weight:600;letter-spacing:.5px;box-shadow:0 3px 10px rgba(25,118,210,.3);transition:.18s;}
        .variant-card .file-input:hover{background:#125a9b;}
        .variant-card .file-input input{position:absolute;inset:0;opacity:0;cursor:pointer;}
        .variant-card .img-thumb{max-height:54px;max-width:72px;border:2px solid #fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.18);transition:transform .25s, box-shadow .25s;object-fit:cover;display:none;background:#f8fbff;}
        .variant-card .img-thumb.show{display:inline-block;}
        .variant-card .img-thumb:hover{transform:scale(1.9) translateY(4px);z-index:10;box-shadow:0 6px 24px rgba(0,0,0,.35);}
        .variant-card .preview-math{grid-column:1 / -1;margin-top:6px;font-size:.85rem;min-height:20px;color:#154;}
        .variant-section-title{margin-top:26px;font-weight:600;font-size:1rem;color:#1b3552;letter-spacing:.5px;}
        .add-variant-btn{margin-top:6px;background:#0d6efd;color:#fff;border:none;padding:10px 16px;border-radius:11px;font-size:.8rem;cursor:pointer;font-weight:600;letter-spacing:.4px;box-shadow:0 4px 14px rgba(13,110,253,.3);transition:.18s;}
        .add-variant-btn:hover{background:#0a58ca;}
        .variant-type-wrap{margin-top:4px;}
        .variant-type-wrap input{transform:scale(1.05);}
        .variant-inline{display:flex;flex-wrap:wrap;gap:10px;}
        .variant-inline > *{flex:1 1 230px;}
        @media (max-width:680px){.variant-card{grid-template-columns:1fr auto;grid-template-rows:auto auto auto;}.variant-card .file-wrap{flex-wrap:wrap;}.variant-card .remove-btn{top:4px;right:4px;}}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    {% load static %}
    <link rel="stylesheet" href="{% static 'teacher_panel/css/formula_panel.css' %}">
</head>
<body>
    <div class="container">
        <h2>Savol qo‘shish</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            {% if error %}
            <div style="background:#fdecea; color:#b71c1c; border:1px solid #f5c6cb; padding:10px 12px; border-radius:8px; margin-bottom:12px;">
                {{ error }}
            </div>
            {% endif %}
            {% if success %}
            <div style="background:#e6fffa; color:#0f766e; border:1px solid #99f6e4; padding:10px 12px; border-radius:8px; margin-bottom:12px;">
                {{ success }}
            </div>
            {% endif %}

            {% if target == 'student' %}
                <label>Fakultet:</label>
                <select name="faculty" id="faculty-select" required onchange="loadGroupsByFaculty()">
                    <option value="">Fakultetni tanlang</option>
                    {% for faculty in faculties %}
                        <option value="{{ faculty.id }}" {% if selected.faculty == faculty.id|stringformat:'s' %}selected{% endif %}>{{ faculty.name }}</option>
                    {% endfor %}
                </select>

                <label>Guruh:</label>
                <!-- Keep native select for form semantics; hide and control via custom UI -->
                <select name="groups" id="group-select" multiple required style="display:none;">
                    {% for group in groups %}
                        <option value="{{ group.id }}" data-faculty="{{ group.faculty_id }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
                <div id="group-ms" class="ms-container"></div>
<script>
function loadGroupsByFaculty() {
    var facultyId = document.getElementById('faculty-select').value;
    var groupSelect = document.getElementById('group-select');
    // hide options not matching faculty and unselect them
    Array.from(groupSelect.options).forEach(function(opt){
        if (!opt.value) return;
        if (opt.getAttribute('data-faculty') === facultyId || facultyId === '') {
            opt.disabled = false; opt.dataset.hidden = '0';
        } else {
            opt.disabled = true; opt.selected = false; opt.dataset.hidden = '1';
        }
    });
    // refresh custom UI if present
    if (window.__teacherGroupMS && typeof window.__teacherGroupMS.refresh === 'function') {
        window.__teacherGroupMS.refresh();
    }
}
window.onload = function() {
    updatePreview();
    toggleAnswerFields();
    document.getElementById('formula-popup').style.display = 'none';
    loadGroupsByFaculty();
    // Reload subjects if selections are already present (after success)
    try { loadSubjects(); } catch(e){}
};
</script>

                <label>Semestr:</label>
                <select name="semester" id="semester-select" required>
                    {% for semester in semesters %}
                        <option value="{{ semester.id }}" {% if selected.semester == semester.id|stringformat:'s' %}selected{% endif %}>{{ semester.number }}-semestr</option>
                    {% endfor %}
                </select>

                <label>Fan:</label>
                <select name="subject" id="subject-select" required>
                    <option value="">Fanni tanlang</option>
                    {% for subject in subjects %}
                        <option value="{{ subject.id }}" {% if selected.subject == subject.id|stringformat:'s' %}selected{% endif %}>{{ subject.name }}</option>
                    {% endfor %}
                </select>

<script>
async function loadSubjects() {
    const groupId = Array.from(document.getElementById('group-select').selectedOptions).map(o=>o.value).join(',');
    const semesterId = document.getElementById('semester-select').value;
    if (!groupId || !semesterId) return;

    try {
    const response = await fetch(`/api/teacher-panel/get-subjects-by-group-semester/?group_id=${groupId}&semester_id=${semesterId}`);
        const data = await response.json();
        const subjectSelect = document.getElementById('subject-select');
        subjectSelect.innerHTML = '<option value="">Fanni tanlang</option>';
        data.subjects.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject.id;
            option.textContent = subject.name;
            subjectSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading subjects:', error);
    }
}

// Event listener qo'shish
document.getElementById('group-select').addEventListener('change', loadSubjects);
document.getElementById('semester-select').addEventListener('change', loadSubjects);
</script>

            {% elif target == 'tutor' %}
                <label>Kafedra:</label>
                <select name="kafedra" required>
                    {% for kafedra in kafedralar %}
                        <option value="{{ kafedra.id }}" {% if selected.kafedra == kafedra.id|stringformat:'s' %}selected{% endif %}>{{ kafedra.name }} ({{ kafedra.faculty.name }})</option>
                    {% endfor %}
                </select>
            {% elif target == 'employee' %}
                <label>Bo'lim:</label>
                <select name="bulim" required>
                    {% for bulim in bulimlar %}
                        <option value="{{ bulim.id }}" {% if selected.bulim == bulim.id|stringformat:'s' %}selected{% endif %}>{{ bulim.name }}</option>
                    {% endfor %}
                </select>
            {% endif %}

            <label>Savol matni:</label>
            <div class="textarea-wrapper" style="margin-bottom:0; position:relative;">
                <textarea id="question-text" name="text" rows="3" required oninput="updatePreview()">{% if edit_mode %}{{ question.text }}{% endif %}</textarea>
                <!-- Inline formula popup removed; use global ∑ panel (Ctrl+M). -->
            </div>
            <!-- Rasm yuklash maydoni -->
            <label>Rasm yuklash (ixtiyoriy):</label>
            <input type="file" name="question_image" accept="image/*" style="margin-bottom: 12px;">
            <div class="preview-label">Ko‘rinishi:</div>
            <div class="preview-box" id="formula-preview"></div>

            <label>Savol turi:</label>
            <select name="question_type" id="question-type-select" required onchange="toggleAnswerFields()">
                {% for value, label in question_types %}
                    <option value="{{ value }}" {% if selected.question_type == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>

            <button type="submit">Qo‘shish</button>
            <div id="single-choice-fields" style="display:none;">
                <label>Javob variantlari (bitta to‘g‘ri):</label>
                <div id="single-choice-options"><!-- rows injected dynamically --></div>
                <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addSingleChoiceOption()">Yana variant qo‘shish</button>
            </div>
            <div id="multiple-choice-fields" style="display:none;">
                <label>Javob variantlari (bir nechta to‘g‘ri):</label>
                <div id="multiple-choice-options"><!-- rows injected dynamically --></div>
                <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addMultipleChoiceOption()">Yana variant qo‘shish</button>
            </div>
            <div id="fill-blank-fields" style="display:none;">
                <label>To‘g‘ri javob (bo‘sh joyni to‘ldirish):</label>
                <input type="text" name="fill_blank_answer" placeholder="To‘g‘ri javob">
            </div>
            <div id="true-false-fields" style="display:none;">
                <label>To‘g‘ri javob:</label>
                <select name="true_false_answer">
                    <option value="true">To‘g‘ri</option>
                    <option value="false">Noto‘g‘ri</option>
                </select>
            </div>
            <div id="matching-fields" style="display:none;">
                <label>Matching variantlari (chapda so‘z, o‘ngda javob):</label>
                <div style="color:#007bff; font-size:15px; margin-bottom:8px;">
                    Har bir javob uchun <b>matn yoki rasm</b> kiritish mumkin. Agar rasm yuklansa, matn bo‘sh qolishi mumkin.
                </div>
                <div id="matching-options">
                    <div class="matching-row d-flex align-items-center mb-2">
                        <input type="text" name="matching_left_1" placeholder="So‘z (masalan: I)" style="width:30%; margin-right:8px;">
                        <span style="font-weight:600; margin-right:8px;">—</span>
                        <input type="text" name="matching_right_1" placeholder="Javob (masalan: am)" style="width:30%; margin-right:8px;">
                        <input type="file" name="matching_image_1" accept="image/*" style="width:20%; margin-right:8px;">
                        <button type="button" class="remove-variant-btn" onclick="removeVariant(this)" title="O‘chirish">&times;</button>
                    </div>
                    <div class="matching-row d-flex align-items-center mb-2">
                        <input type="text" name="matching_left_2" placeholder="So‘z (masalan: you)" style="width:30%; margin-right:8px;">
                        <span style="font-weight:600; margin-right:8px;">—</span>
                        <input type="text" name="matching_right_2" placeholder="Javob (masalan: are)" style="width:30%; margin-right:8px;">
                        <input type="file" name="matching_image_2" accept="image/*" style="width:20%; margin-right:8px;">
                        <button type="button" class="remove-variant-btn" onclick="removeVariant(this)" title="O‘chirish">&times;</button>
                    </div>
                    <div class="matching-row d-flex align-items-center mb-2">
                        <input type="text" name="matching_left_3" placeholder="So‘z (masalan: it)" style="width:30%; margin-right:8px;">
                        <span style="font-weight:600; margin-right:8px;">—</span>
                        <input type="text" name="matching_right_3" placeholder="Javob (masalan: is)" style="width:30%; margin-right:8px;">
                        <input type="file" name="matching_image_3" accept="image/*" style="width:20%; margin-right:8px;">
                        <button type="button" class="remove-variant-btn" onclick="removeVariant(this)" title="O‘chirish">&times;</button>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addMatchingOption()">Yana qator qo‘shish</button>
            </div>

        </form>
        <script>
// eski lokal formula popup funksiyasi o'chirildi (global panel ishlatiladi)
            function insertLatexToInput(latex, btn) {
                // Find the closest input[type="text"] in the same answer row as the button
                let row = btn.closest('.single-choice-row, .multiple-choice-row, .matching-row, .ordering-row');
                let input = row ? row.querySelector('input[type="text"]') : null;
                if (!input) {
                    // fallback: try parent div
                    input = btn.closest('div').querySelector('input[type="text"]');
                }
                if (!input) return;
                const start = input.selectionStart;
                const end = input.selectionEnd;
                const before = input.value.substring(0, start);
                const after = input.value.substring(end);
                input.value = before + latex + after;
                input.focus();
                input.setSelectionRange(start + latex.length, start + latex.length);
                updateVariantPreview(input);
            }
            function updateVariantPreview(input) {
                // Show a preview for each variant under the row
                let row = input.closest('.single-choice-row');
                let preview = row ? row.querySelector('.variant-preview') : null;
                if (!preview) return;
                let latex = input.value.trim();
                preview.innerHTML = latex ? '\\(' + latex + '\\)' : '';
                if(window.MathJax){
                    if(MathJax.typesetPromise){MathJax.typesetPromise([preview]);}
                    else if(MathJax.typeset){MathJax.typeset([preview]);}
                }
            }
            function insertLatex(latex) {
                const textarea = document.getElementById('question-text');
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const before = textarea.value.substring(0, start);
                const after = textarea.value.substring(end);
                textarea.value = before + latex + after;
                textarea.focus();
                textarea.setSelectionRange(start + latex.length, start + latex.length);
                updatePreview();
            }
            function updatePreview() {
                let latex = document.getElementById('question-text').value;
                document.getElementById('formula-preview').innerHTML = latex ? '\\(' + latex + '\\)' : '';
                if (window.MathJax && MathJax.typesetPromise) {
                    MathJax.typesetPromise([document.getElementById('formula-preview')]);
                } else if (window.MathJax && MathJax.typeset) {
                    MathJax.typeset([document.getElementById('formula-preview')]);
                }
            }
            // Global debounced preview (agar oldingi blok o'chirilgan bo'lsa qayta tiklaymiz)
            if(!window.debouncedPreview){
                let __pvTimer=null;
                window.debouncedPreview=function(){
                    clearTimeout(__pvTimer);
                    __pvTimer=setTimeout(updatePreview,200);
                };
                const __q=document.getElementById('question-text');
                if(__q){ __q.addEventListener('input', window.debouncedPreview); }
            }
            // Variant functions
            function removeVariant(btn) {
                var parentRow = btn.closest('.single-choice-row, .multiple-choice-row, .matching-row, .ordering-row');
                if (parentRow) parentRow.remove();
            }
            var matchingCount = 4;
            function addMatchingOption() {
                matchingCount++;
                var container = document.getElementById('matching-options');
                var div = document.createElement('div');
                div.className = 'matching-row d-flex align-items-center mb-2';
                div.innerHTML =
                    '<input type="text" name="matching_left_' + matchingCount + '" placeholder="So‘z (masalan: ...)" style="width:30%; margin-right:8px;">' +
                    '<span style="font-weight:600; margin-right:8px;">—</span>' +
                    '<input type="text" name="matching_right_' + matchingCount + '" placeholder="Javob (masalan: ...)" style="width:30%; margin-right:8px;">' +
                    '<input type="file" name="matching_image_' + matchingCount + '" accept="image/*" style="width:20%; margin-right:8px;">' +
                    '<button type="button" class="remove-variant-btn" onclick="removeVariant(this)" title="O‘chirish">&times;</button>';
                container.appendChild(div);
            }
            var orderingCount = 4;
            function addOrderingOption() {
                orderingCount++;
                var container = document.getElementById('ordering-options');
                var div = document.createElement('div');
                div.className = 'ordering-row';
                div.innerHTML = '<input type="text" name="ordering_' + orderingCount + '" placeholder="' + orderingCount + '-variant">' +
                    '<button type="button" class="remove-variant-btn" onclick="removeVariant(this)" title="O‘chirish">&times;</button>';
                container.appendChild(div);
            }
            function toggleAnswerFields() {
                var type = document.getElementById('question-type-select').value;
                document.getElementById('single-choice-fields').style.display = (type === 'single_choice') ? 'block' : 'none';
                document.getElementById('multiple-choice-fields').style.display = (type === 'multiple_choice') ? 'block' : 'none';
                document.getElementById('fill-blank-fields').style.display = (type === 'fill_in_blank') ? 'block' : 'none';
                document.getElementById('true-false-fields').style.display = (type === 'true_false') ? 'block' : 'none';
                document.getElementById('matching-fields').style.display = (type === 'matching') ? 'block' : 'none';
                
            }
            function previewOptionImage(input){
                const file = input.files && input.files[0];
                const img = input.closest('.file-input').parentElement.querySelector('.img-thumb');
                if(!img) return;
                if(file){
                    const url = URL.createObjectURL(file);
                    img.src = url; img.classList.add('show');
                } else { img.src=''; img.classList.remove('show'); }
            }
            var singleChoiceCount = 4;
            function addSingleChoiceOption() {
                singleChoiceCount++;
                var container = document.getElementById('single-choice-options');
                var div = document.createElement('div');
                div.className = 'single-choice-row';
                div.innerHTML = '<div style="position:relative; flex:1 1 auto; display:flex; align-items:center; gap:6px;">'
                    + '<input type="text" name="single_option_' + singleChoiceCount + '" placeholder="Variant ' + singleChoiceCount + '" class="variant-input">'
                    + '<input type="file" name="single_image_' + singleChoiceCount + '" accept="image/*" class="variant-image-input" onchange="previewOptionImage(this)">' 
                    + '<img class="img-thumb" style="display:none;" alt="" />'
                    + '<div class="variant-preview" style="margin-top:2px; min-height:22px; background:#f8f9fa; border-radius:4px; padding:2px 8px; font-size:15px; color:#333;"></div>'
                    + '</div>'
                    + ' <input type="radio" name="single_correct" value="' + singleChoiceCount + '"> To‘g‘ri'
                    + '<button type="button" class="remove-variant-btn" onclick="removeVariant(this)" title="O‘chirish">&times;</button>';
                container.appendChild(div);
            }
            var multipleChoiceCount = 4;
            function addMultipleChoiceOption() {
                multipleChoiceCount++;
                var container = document.getElementById('multiple-choice-options');
                var div = document.createElement('div');
                div.className = 'multiple-choice-row';
                div.innerHTML = '<input type="text" name="multi_option_' + multipleChoiceCount + '" placeholder="Variant ' + multipleChoiceCount + '">' 
                    + '<input type="file" name="multi_image_' + multipleChoiceCount + '" accept="image/*" class="variant-image-input" onchange="previewOptionImage(this)">' 
                    + '<img class="img-thumb" style="display:none;" alt="" />'
                    + ' <input type="checkbox" name="multi_correct_' + multipleChoiceCount + '"> To‘g‘ri'
                    + '<button type="button" class="remove-variant-btn" onclick="removeVariant(this)" title="O‘chirish">&times;</button>';
                container.appendChild(div);
            }
        // Auto build initial 4 rows for each choice type if empty
        window.addEventListener('DOMContentLoaded', function(){
            const sc = document.getElementById('single-choice-options');
            const mc = document.getElementById('multiple-choice-options');
            if(sc && sc.children.length === 0){
                window.singleChoiceCount = 0;
                for(let i=0;i<4;i++){ addSingleChoiceOption(); }
            }
            if(mc && mc.children.length === 0){
                window.multipleChoiceCount = 0;
                for(let i=0;i<4;i++){ addMultipleChoiceOption(); }
            }
        });
        </script>
    {% include 'teacher_panel/partials/_formula_panel.html' %}
    {% load static %}
    <script src="{% static 'teacher_panel/js/formula_panel.js' %}"></script>
        <div class="back-link">
            <a href="/api/teacher-panel/dashboard/">← Panelga qaytish</a>
        </div>
    </div>
</body>
</html>