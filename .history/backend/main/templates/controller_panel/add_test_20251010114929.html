<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Test yaratish</title>
<style>body{font-family:Inter,Arial,sans-serif;background:url('/static/main/1.png') center/cover fixed;margin:0;padding:0;}
.container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem;}
.card{width:100%;max-width:640px;background:rgba(255,255,255,.15);backdrop-filter:blur(18px);border:1px solid rgba(255,255,255,.25);border-radius:26px;padding:42px 40px 34px;box-shadow:0 10px 40px -8px rgba(0,0,0,.4);position:relative;overflow:hidden;}
.card h1{margin:0 0 28px;font-size:2.1rem;letter-spacing:.5px;color:#fff;font-weight:700;text-align:center;}
label{display:block;margin:18px 0 6px;font-weight:600;color:#fff;font-size:.95rem;letter-spacing:.4px;}
input[type=text],input[type=number],select{width:100%;padding:14px 15px;border:1px solid rgba(255,255,255,.3);border-radius:14px;background:rgba(0,0,0,.35);color:#fff;font-size:.95rem;outline:none;transition:.25s;color-scheme: dark;}
input:focus,select:focus{border-color:#6bb6ff;box-shadow:0 0 0 3px #6bb6ff44;}
/* Ensure dropdown options are visible in dark theme across Windows/Edge/Chrome */
select option, select optgroup {background:#0f172a !important; color:#ffffff !important;}
/* Also hint the UA to prefer dark popups */
body{color-scheme: dark;}
/* Disabled placeholder option style */
select option[disabled] {color:#9ca3af !important;}
small.helper{color:#ddd;margin-top:4px;display:block;font-size:.72rem;letter-spacing:.5px;}
.error{background:#ffe0e0;color:#8b0000;padding:12px 16px;border-radius:12px;margin-bottom:12px;font-weight:600;font-size:.9rem;}
.teacher-box{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.25);border-radius:18px;padding:14px 14px 18px;margin-top:4px;}
.teacher-search{width:100%;padding:10px 14px;margin-bottom:10px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:12px;color:#fff;outline:none;font-size:.82rem;}
.teacher-list{max-height:210px;overflow:auto;border:1px solid rgba(255,255,255,.2);border-radius:14px;background:linear-gradient(135deg,rgba(255,255,255,.07),rgba(255,255,255,.16));padding:4px;display:flex;flex-direction:column;gap:4px;}
.t-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:11px;background:rgba(0,0,0,.3);color:#fff;font-size:.8rem;font-weight:500;cursor:pointer;transition:.25s;position:relative;}
.t-item:hover{background:rgba(0,0,0,.55);} .t-item input{margin:0;}
.tagline{color:#ffd; font-size:.7rem;font-weight:500;margin-top:4px;letter-spacing:.4px;}
.submit-btn{margin-top:28px;width:100%;padding:15px 20px;border:none;border-radius:16px;background:linear-gradient(135deg,#5fa8ff,#2b6bff);color:#fff;font-size:1.05rem;font-weight:700;letter-spacing:.6px;cursor:pointer;box-shadow:0 8px 25px -6px rgba(0,0,0,.45);transition:.3s;}
.submit-btn:hover{transform:translateY(-2px);box-shadow:0 12px 32px -4px rgba(0,0,0,.55);} .back-link{display:block;text-align:center;color:#fff;margin-top:20px;text-decoration:none;font-weight:500;}
.video-toggle{margin-top:12px;width:100%;padding:13px 16px;border:1px solid rgba(255,255,255,.3);border-radius:14px;background:linear-gradient(135deg,rgba(255,255,255,.22),rgba(255,255,255,.08));color:#fff;font-weight:600;cursor:pointer;}
#video-fields{display:none;margin-top:12px;animation:fade .3s;}@keyframes fade{from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:translateY(0);}}
@media(max-width:680px){.card{padding:32px 24px 26px;} .card h1{font-size:1.7rem;} }
</style>
</head>
<body>
<div class="container"><div class="card">
<h1>Yangi Test</h1>
{% if error %}<div class="error">{{ error }}</div>{% endif %}
<form method="post" enctype="multipart/form-data">{% csrf_token %}
<input type="hidden" name="target" value="{{ target }}" />
<label for="title">Test nomi</label>
<input type="text" name="title" id="title" placeholder="Masalan: 1-oraliq nazorat" />
{% if target == 'tutor' %}
<label for="kafedra">Kafedra</label>
<select name="kafedra" id="kafedra" required>
    <option value="">Kafedra tanlang...</option>
    {% for k in kafedralar %}<option value="{{ k.id }}">{{ k.name }}</option>{% endfor %}
</select>
{% elif target == 'employee' %}
<label for="bulim">Bo'lim</label>
<select name="bulim" id="bulim" required>
    <option value="">Bo'lim tanlang...</option>
    {% for b in bulimlar %}<option value="{{ b.id }}">{{ b.name }}</option>{% endfor %}
</select>
{% endif %}
<label for="subject">Fan</label>
<select name="subject" id="subject" required {% if target == 'tutor' or target == 'employee' %}disabled{% endif %}>
    <option value="">{% if target == 'tutor' %}Avval kafedra tanlang{% elif target == 'employee' %}Avval bo'lim tanlang{% else %}Fan tanlang...{% endif %}</option>
    {% if target == 'student' %}{% for s in subjects %}<option value="{{ s.id }}">{{ s.name }}</option>{% endfor %}{% endif %}
</select>
{% if target == 'student' %}
<label for="semester">Semestr</label>
<select name="semester" id="semester" required>
    <option value="">Semestr tanlang...</option>
    {% for sm in semesters %}<option value="{{ sm.id }}">{{ sm.name }}</option>{% endfor %}
</select>
{% endif %}
<label>O‘qituvchilar (filtr – tanlanmagan bo‘lsa hammasi)</label>
<div class="teacher-box">
    <input type="text" id="teacher-search" class="teacher-search" placeholder="Qidirish..." />
    <div id="teacher-list" class="teacher-list"></div>
    <div class="tagline" id="teacher-info">{% if target == 'student' %}Fan & semestr tanlang.{% else %}Fan tanlang.{% endif %}</div>
</div>
<label for="question_count">Savollar soni</label>
<input type="number" name="question_count" id="question_count" min="1" required />
<small class="helper" id="qmax_hint"></small>
<label for="total_score">Umumiy ball</label>
<input type="number" name="total_score" id="total_score" min="1" required />
<label for="minutes">Test vaqti (daqiqa)</label>
<input type="number" name="minutes" id="minutes" min="1" value="30" required />
<label for="duration">Test muddati (soat:daqiq:soniya)</label>
<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">
    <input type="number" id="dur_h" min="0" max="23" value="0" style="width:80px;" />
    <span style="color:#fff;font-weight:600;">:</span>
    <input type="number" id="dur_m" min="0" max="59" value="30" style="width:80px;" />
    <span style="color:#fff;font-weight:600;">:</span>
    <input type="number" id="dur_s" min="0" max="59" value="0" style="width:80px;" />
    <input type="text" name="duration" id="duration" readonly style="flex:1;min-width:140px;" />
</div>
<div style="display:flex;flex-wrap:wrap;gap:6px;">
    <button type="button" class="preset" data-set="00:10:00">10m</button>
    <button type="button" class="preset" data-set="00:15:00">15m</button>
    <button type="button" class="preset" data-set="00:30:00">30m</button>
    <button type="button" class="preset" data-set="00:45:00">45m</button>
    <button type="button" class="preset" data-set="01:00:00">1 soat</button>
</div>
<button type="button" id="video-toggle" class="video-toggle">▶️ Video qo‘shish</button>
<div id="video-fields">
    <label for="video_url">Video URL</label>
    <input type="text" name="video_url" id="video_url" placeholder="https://..." />
    <label for="video_file">Video fayl</label>
    <input type="file" name="video_file" id="video_file" accept="video/*" />
</div>
<button type="submit" class="submit-btn">Yaratish</button>
</form>
<a href="/api/controller-panel/dashboard/" class="back-link">⬅️ Panelga qaytish</a>
</div></div>
<script>
(function(){
 const target=('{{ target }}'||'').trim();
 const subjectSel=document.getElementById('subject');
 const kafSel=document.getElementById('kafedra');
 const bulSel=document.getElementById('bulim');
 const semesterSel=document.getElementById('semester');
 const teacherList=document.getElementById('teacher-list');
 const teacherInfo=document.getElementById('teacher-info');
 const search=document.getElementById('teacher-search');
 const qCount=document.getElementById('question_count');
 const qHint=document.getElementById('qmax_hint');
 function updateDuration(){function pad(v){return String((+v||0)).padStart(2,'0');}const h=pad(dur_h.value),m=pad(dur_m.value),s=pad(dur_s.value);duration.value=`${h}:${m}:${s}`;}
 const dur_h=document.getElementById('dur_h'),dur_m=document.getElementById('dur_m'),dur_s=document.getElementById('dur_s'),duration=document.getElementById('duration');
 [dur_h,dur_m,dur_s].forEach(e=>e.addEventListener('input',updateDuration));document.querySelectorAll('.preset').forEach(b=>b.addEventListener('click',()=>{const p=b.dataset.set.split(':');dur_h.value=+p[0];dur_m.value=+p[1];dur_s.value=+p[2];updateDuration();}));updateDuration();
 document.getElementById('video-toggle').addEventListener('click',(e)=>{const box=document.getElementById('video-fields');const open=box.style.display!=='none';box.style.display=open?'none':'block';e.target.textContent=open?'▶️ Video qo‘shish':'⬇️ Video maydonlarini yashirish';});
 function loadSubjectsByContainer(){
   if(!(target==='tutor'||target==='employee')) return;
   let url='/api/controller-panel/get-subjects-by-kafedra-or-bulim/?';
   if(target==='tutor'){
     const kid=kafSel.value; if(!kid){subjectSel.innerHTML='<option value="">Avval kafedra</option>';subjectSel.disabled=true;return;} url+=`kafedra_id=${kid}`;
   } else if(target==='employee'){
     const bid=bulSel.value; if(!bid){subjectSel.innerHTML='<option value="">Avval bo\'lim</option>';subjectSel.disabled=true;return;} url+=`bulim_id=${bid}`;
   }
   // Enable immediately to allow user interaction even if fetch is slow
   subjectSel.disabled=false;
   subjectSel.innerHTML='<option value="">Yuklanmoqda...</option>';
   fetch(url)
     .then(r=>{if(!r.ok) throw new Error('HTTP '+r.status); return r.json();})
     .then(d=>{
       const arr=d.subjects||[];
       subjectSel.innerHTML='<option value="">Fan tanlang...</option>' + arr.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
       teacherList.innerHTML=''; teacherInfo.textContent='Fan tanlang';
     })
     .catch(err=>{
       console.error('Subjects load error:',err);
       subjectSel.innerHTML='<option value="">Fanlarni yuklab bo\'lmadi (yana urinib ko\'ring)</option>';
       // keep it enabled so user can try again via reselecting container
       subjectSel.disabled=false;
     });
 }
 if(kafSel){ kafSel.addEventListener('change',()=>{loadSubjectsByContainer();}); }
 if(bulSel){ bulSel.addEventListener('change',()=>{loadSubjectsByContainer();}); }
 function fetchTeachers(){
   teacherList.innerHTML=''; const sid=subjectSel.value; if(!sid){teacherInfo.textContent='Fan tanlang';return;}
   let url=`/api/controller-panel/get-teachers-by-subject-semester/?subject_id=${sid}`;
   if(target==='student'){const sem=semesterSel?semesterSel.value:''; if(sem) url+=`&semester_id=${sem}`;}
   if(target==='tutor' && kafSel && kafSel.value) url+=`&kafedra_id=${kafSel.value}`;
   if(target==='employee' && bulSel && bulSel.value) url+=`&bulim_id=${bulSel.value}`;
   fetch(url).then(r=>r.json()).then(d=>{const arr=d.teachers||[];teacherInfo.textContent=arr.length?`Topildi: ${arr.length} o‘qituvchi`:'O‘qituvchi topilmadi';arr.forEach(t=>{const div=document.createElement('label');div.className='t-item';div.dataset.name=(t.full_name||'').toLowerCase();div.innerHTML=`<input type='checkbox' name='teacher_ids' value='${t.id}'> <span>${t.full_name}</span><span style='margin-left:auto;font-size:.65rem;opacity:.7;'>${t.qcount} savol</span>`;teacherList.appendChild(div);});});
 }
 function filterTeachers(){const q=(search.value||'').toLowerCase();Array.from(teacherList.children).forEach(ch=>{ch.style.display= ch.dataset.name.includes(q)?'flex':'none';});}
 search.addEventListener('input',filterTeachers);
 subjectSel.addEventListener('change',()=>{fetchTeachers();});
 if(semesterSel){semesterSel.addEventListener('change',()=>{fetchTeachers();});}
 // Initial teacher load only for student target (others depend on subject chosen after container)
 if(target==='student') fetchTeachers();
 // Agar target tutor/employee va konteyner tanlangan bo'lsa (back nav) subject ni qayta yuklash
 if(target==='tutor' && kafSel && kafSel.value){ loadSubjectsByContainer(); }
 if(target==='employee' && bulSel && bulSel.value){ loadSubjectsByContainer(); }
 // Force visible option colors in some Windows browsers by toggling a helper class
 const selects=[...document.querySelectorAll('select')];
 selects.forEach(s=>{
   s.addEventListener('focus',()=>s.classList.add('open-select'));
   s.addEventListener('blur',()=>s.classList.remove('open-select'));
 });
})();
</script>
</body>
</html>